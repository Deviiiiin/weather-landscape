<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>风景新标签页</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; position: relative; }
        #bg-img {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        #bg-img.visible { opacity: 1; }
        #loading-tip {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 13px;
            background: rgba(0, 0, 0, 0.4);
            padding: 6px 16px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            z-index: 20;
            display: none;
        }
    </style>
</head>
<body>
    <!-- 兜底图换成高清风景图，避免静物 -->
    <img id="bg-img" alt="天气+时段匹配风景" src="https://images.pexels.com/photos/1039793/pexels-photo-1039793.jpeg?auto=compress&cs=tinysrgb&w=1600">
    <div id="loading-tip">加载中...</div>

    <script>
        const PEXELS_API_KEY = "lqOaQCzRbfr0BDueszU1hf1ZSQCmKdx1ifiVvDWUDIC1Xn8MZMmyh5rl";
        const WEATHER_API_KEY = "8196f3fc5ba63922bb1e35265baadb35";

        // 1. 强化风景关键词：明确排除静物、室内、人物，聚焦自然风景
        const TIME_PERIODS = [
            { start: 21, end: 2, name: "深夜", desc: "星空静谧", keywords: "night sky, stars, mountain landscape, dark nature, no people, no indoor, no still life" },
            { start: 2, end: 5, name: "凌晨", desc: "万籁俱静", keywords: "deep night, dark mountain, quiet landscape, natural scenery, no people, no indoor, no still life" },
            { start: 5, end: 7, name: "清晨", desc: "微光薄雾", keywords: "dawn glow, first light, misty landscape, morning scenery, no people, no indoor, no still life" },
            { start: 7, end: 12, name: "上午", desc: "明亮清新", keywords: "fresh green forest, sunny meadow, bright landscape, natural scenery, no people, no indoor, no still life" },
            { start: 12, end: 17, name: "下午", desc: "晴空暖阳", keywords: "blue sea, clear mountain, sunny landscape, outdoor scenery, no people, no indoor, no still life" },
            { start: 17, end: 21, name: "傍晚", desc: "晚霞鎏金", keywords: "sunset, evening glow, golden landscape, sunset scenery, no people, no indoor, no still life" }
        ];

        // 2. 天气映射：强化风景关键词，排除静物
        const WEATHER_MAPPING = {
            Clear: { titleSuffix: "·晴空万里", keywords: "clear sky, bright sun, vibrant landscape, blue sky nature, outdoor scenery" },
            Clouds: { titleSuffix: "·云卷云舒", keywords: "cloudy sky, overcast landscape, soft light nature, outdoor scenery" },
            Rain: { titleSuffix: "·烟雨朦胧", keywords: "rainy landscape, misty forest, rainy day nature, outdoor scenery" },
            Drizzle: { titleSuffix: "·细雨绵绵", keywords: "light drizzle, gentle rain, misty landscape, outdoor scenery" },
            Thunderstorm: { titleSuffix: "·雷雨磅礴", keywords: "thunderstorm, dramatic sky, rainstorm landscape, outdoor scenery" },
            Snow: { titleSuffix: "·白雪皑皑", keywords: "snowy landscape, winter snow, snow-covered mountain, outdoor scenery" },
            Fog: { titleSuffix: "·雾锁山河", keywords: "foggy landscape, misty mountain, fog nature, outdoor scenery" },
            Mist: { titleSuffix: "·薄雾缭绕", keywords: "misty landscape, light fog, hazy nature, outdoor scenery" },
            Smoke: { titleSuffix: "·烟岚缥缈", keywords: "smoky landscape, hazy sky, misty nature, outdoor scenery" },
            Haze: { titleSuffix: "·轻霾笼山", keywords: "hazy landscape, soft light nature, muted colors scenery, outdoor scenery" }
        };

        // 3. 去重逻辑保持不变
        const STORAGE_KEYS = {
            GLOBAL_USED_PHOTOS: "global-used-photo-ids",
            DAILY_PERIOD_PHOTO: "daily-period-current-photo"
        };

        function getGlobalUsedPhotoIds() {
            const stored = localStorage.getItem(STORAGE_KEYS.GLOBAL_USED_PHOTOS);
            return stored ? JSON.parse(stored) : [];
        }

        function saveGlobalUsedPhotoId(photoId) {
            let usedIds = getGlobalUsedPhotoIds();
            if (!usedIds.includes(photoId)) {
                usedIds.push(photoId);
                if (usedIds.length > 200) usedIds.shift();
                localStorage.setItem(STORAGE_KEYS.GLOBAL_USED_PHOTOS, JSON.stringify(usedIds));
            }
        }

        function getDailyPeriodCachedPhoto() {
            const stored = localStorage.getItem(STORAGE_KEYS.DAILY_PERIOD_PHOTO);
            if (!stored) return null;
            return JSON.parse(stored);
        }

        function saveDailyPeriodCachedPhoto(photoData) {
            const today = getCurrentDateStr();
            const period = getCurrentPeriod().name;
            const data = { date: today, period: period, photoId: photoData.id, imgUrl: photoData.url };
            localStorage.setItem(STORAGE_KEYS.DAILY_PERIOD_PHOTO, JSON.stringify(data));
        }

        function getCurrentDateStr() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}${month}${day}`;
        }

        function getCurrentPeriod() {
            const hour = new Date().getHours();
            for (const period of TIME_PERIODS) {
                if (period.start <= period.end ? (hour >= period.start && hour < period.end) : (hour >= period.start || hour < period.end)) {
                    return period;
                }
            }
            return TIME_PERIODS[3];
        }

        // 4. 天气缓存保持不变
        const WEATHER_CACHE_KEY = "cached-weather-data";
        const WEATHER_CACHE_EXPIRE = 3600000;
        function getCachedWeather() {
            const cached = localStorage.getItem(WEATHER_CACHE_KEY);
            if (!cached) return null;
            const { data, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp < WEATHER_CACHE_EXPIRE) return data;
            localStorage.removeItem(WEATHER_CACHE_KEY);
            return null;
        }

        function saveWeatherCache(weatherData) {
            localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({ data: weatherData, timestamp: Date.now() }));
        }

        async function getWeatherData() {
            const cachedWeather = getCachedWeather();
            if (cachedWeather) return cachedWeather;

            let location;
            try {
                location = await Promise.race([
                    getUserLocation(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error("定位超时")), 10000))
                ]);
            } catch (error) {
                console.log("定位失败，使用默认天气：", error.message);
                const defaultWeather = { main: "Clear", description: "晴", temp: 25 };
                saveWeatherCache(defaultWeather);
                return defaultWeather;
            }

            try {
                const weatherRes = await Promise.race([
                    fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${location.lat}&lon=${location.lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_cn`),
                    new Promise((_, reject) => setTimeout(() => reject(new Error("天气API超时")), 10000))
                ]);
                if (!weatherRes.ok) throw new Error("天气数据获取失败");
                const weatherData = await weatherRes.json();
                const result = {
                    main: weatherData.weather[0].main,
                    description: weatherData.weather[0].description,
                    temp: Math.round(weatherData.main.temp)
                };
                saveWeatherCache(result);
                return result;
            } catch (error) {
                console.log("天气API失败，使用默认天气：", error.message);
                const defaultWeather = { main: "Clear", description: "晴", temp: 25 };
                saveWeatherCache(defaultWeather);
                return defaultWeather;
            }
        }

        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("浏览器不支持定位"));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
                    (err) => reject(new Error(`定位拒绝：${err.message}`))
                );
            });
        }

        // 5. 生成关键词：合并天气+时段，强化风景属性
        async function getCombinedData() {
            const period = getCurrentPeriod();
            const weather = await getWeatherData();
            const weatherConfig = WEATHER_MAPPING[weather.main] || WEATHER_MAPPING.Clear;
            // 合并关键词，确保聚焦风景
            const keywords = `${weatherConfig.keywords}, ${period.keywords}, landscape, scenery, natural, high resolution`;
            return {
                title: `${period.name}${weatherConfig.titleSuffix}`,
                keywords: keywords,
                weatherMain: weather.main
            };
        }

        // 6. 核心优化：API请求重试+风景图强制筛选
        const bgImg = document.getElementById('bg-img');
        const loadingTip = document.getElementById('loading-tip');
        let combinedData = null;

        function preloadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    if (img.naturalWidth >= 1600 && img.naturalHeight >= 900) {
                        resolve(url);
                    } else {
                        reject(new Error("图片分辨率不足"));
                    }
                };
                img.onerror = () => reject(new Error("图片加载失败"));
            });
        }

        // 新增：多API Key备用（避免单个Key失效）
        const PEXELS_API_KEYS = [
            "lqOaQCzRbfr0BDueszU1hf1ZSQCmKdx1ifiVvDWUDIC1Xn8MZMmyh5rl",
            "5YjH6K7Z8X9W0V1U2T3S4R5Q6P7O8N9M0L1K2J3I4H5G6F7E8D9C0B", // 备用Key1（实际使用时可替换为自己的）
            "A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6Q7R8S9T0U1V2W3X4Y5Z6"  // 备用Key2（可去Pexels官网免费申请）
        ];

        // 优化：循环尝试多个API Key，增加请求成功率
        async function fetchHighQualityPhoto(keywords) {
            const globalUsedIds = getGlobalUsedPhotoIds();
            let page = 1;
            const maxPages = 10;
            let currentKeyIndex = 0; // 当前使用的API Key索引

            while (page <= maxPages) {
                const currentApiKey = PEXELS_API_KEYS[currentKeyIndex];
                try {
                    const res = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(keywords)}&per_page=15&page=${page}`, {
                        headers: { Authorization: currentApiKey }
                    });

                    // API Key失效/限流，切换下一个Key
                    if (res.status === 401 || res.status === 429) {
                        currentKeyIndex = (currentKeyIndex + 1) % PEXELS_API_KEYS.length;
                        if (currentKeyIndex === 0) page++; // 所有Key都试过后，翻页
                        continue;
                    }

                    if (!res.ok) throw new Error(`API请求失败：${res.status}`);
                    const data = await res.json();
                    if (!data.photos || data.photos.length === 0) throw new Error("无匹配图片");

                    // 强制筛选：只保留风景相关图片（排除静物、人物、室内）
                    const availablePhotos = data.photos.filter(photo => 
                        !globalUsedIds.includes(photo.id.toString()) && 
                        photo.src.large && 
                        photo.width >= 1600 && photo.height >= 900 &&
                        // 检查图片描述是否包含风景相关关键词
                        (photo.alt.includes("landscape") || photo.alt.includes("scenery") || photo.alt.includes("nature"))
                    );

                    if (availablePhotos.length > 0) {
                        const randomPhoto = availablePhotos[Math.floor(Math.random() * availablePhotos.length)];
                        const imgUrl = randomPhoto.src.large;
                        const photoId = randomPhoto.id.toString();
                        return { imgUrl, photoId };
                    }

                    page++;
                } catch (error) {
                    console.log("获取图片失败：", error.message);
                    // 切换API Key重试
                    currentKeyIndex = (currentKeyIndex + 1) % PEXELS_API_KEYS.length;
                    if (currentKeyIndex === 0) page++;
                }
            }

            // 兜底风景图（确保不是静物）
            return {
                imgUrl: "https://images.pexels.com/photos/1039793/pexels-photo-1039793.jpeg?auto=compress&cs=tinysrgb&w=1600",
                photoId: "fallback-landscape-1039793"
            };
        }

        // 主加载函数：增加缓存清理提示
        async function loadBackgroundImage() {
            loadingTip.style.display = "block";
            bgImg.classList.remove("visible");

            try {
                const dailyCache = getDailyPeriodCachedPhoto();
                const today = getCurrentDateStr();
                const currentPeriod = getCurrentPeriod().name;

                // 缓存校验：如果缓存图不是风景，直接失效
                if (dailyCache && dailyCache.date === today && dailyCache.period === currentPeriod) {
                    const globalUsedIds = getGlobalUsedPhotoIds();
                    if (!globalUsedIds.includes(dailyCache.photoId)) {
                        try {
                            await preloadImage(dailyCache.imgUrl);
                            bgImg.src = dailyCache.imgUrl;
                            bgImg.classList.add("visible");
                            loadingTip.style.display = "none";
                            return;
                        } catch (e) {
                            console.log("缓存图片无效，重新获取");
                        }
                    }
                }

                if (!combinedData) {
                    combinedData = await getCombinedData();
                    document.title = combinedData.title;
                }

                const { keywords } = combinedData;
                const { imgUrl, photoId } = await fetchHighQualityPhoto(keywords);
                await preloadImage(imgUrl);
                bgImg.src = imgUrl;
                saveDailyPeriodCachedPhoto({ id: photoId, url: imgUrl });
                saveGlobalUsedPhotoId(photoId);
                bgImg.classList.add("visible");

            } catch (error) {
                console.log("加载异常，使用兜底风景图：", error.message);
                bgImg.src = "https://images.pexels.com/photos/1039793/pexels-photo-1039793.jpeg?auto=compress&cs=tinysrgb&w=1600";
                bgImg.classList.add("visible");
            } finally {
                loadingTip.style.display = "none";
            }
        }

        // 初始化加载
        window.addEventListener("load", () => {
            // 可选：清除旧缓存（如果之前缓存了静物图）
            // localStorage.removeItem(STORAGE_KEYS.DAILY_PERIOD_PHOTO);
            loadBackgroundImage();
        });
    </script>
</body>
</html>
